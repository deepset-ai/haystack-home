{{/* Tutorials page */}}
{{ define "main" }}
  {{ $tutorials := where .Data.Pages "Params.hidden" "!=" true }}
  <div class="grid-page">
    {{/* Hero */}}
    {{ partial "page-hero" . }}
    {{ partial "tutorials-banner" . }}

    <div class="grid-page-content">
      <div class="container container-padded">
        <div class="inner inner-top">
          {{/* Section title */}}
          <div class="title-container">
            <h2 class="section-title">
              {{ len $tutorials }} tutorials for
              <span>all</span> levels
            </h2>

            {{/* Version select */}}
            <div class="select-wrapper">
              <label for="sort">Haystack Version:</label>
              <select id="version-select" class="fixed" onchange="filterAndSort();">
                <option value="2.0">2.0</option>
                <option value="1.0">1.0</option>
              </select>
            </div>
          </div>

          {{/* Sorting options / Filters */}}
          <div class="grid-page-options">
            <div class="filters">
              {{/* Search */}}
              <div class="search-wrapper">
                <input
                  id="search"
                  type="text"
                  placeholder="Search Tutorials"
                  oninput="filterAndSort();"
                />
                <div class="search-icon">
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 20 20"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M19.3187 18.0273L13.232 11.9406C14.1766 10.7195 14.6875 9.22656 14.6875 7.65625C14.6875 5.77656 13.9539 4.01406 12.6273 2.68516C11.3008 1.35625 9.53359 0.625 7.65625 0.625C5.77891 0.625 4.01172 1.35859 2.68516 2.68516C1.35625 4.01172 0.625 5.77656 0.625 7.65625C0.625 9.53359 1.35859 11.3008 2.68516 12.6273C4.01172 13.9562 5.77656 14.6875 7.65625 14.6875C9.22656 14.6875 10.7172 14.1766 11.9383 13.2344L18.025 19.3187C18.0428 19.3366 18.064 19.3508 18.0874 19.3604C18.1107 19.3701 18.1357 19.3751 18.1609 19.3751C18.1862 19.3751 18.2112 19.3701 18.2345 19.3604C18.2578 19.3508 18.279 19.3366 18.2969 19.3187L19.3187 18.2992C19.3366 18.2814 19.3508 18.2602 19.3604 18.2369C19.3701 18.2135 19.3751 18.1885 19.3751 18.1633C19.3751 18.138 19.3701 18.113 19.3604 18.0897C19.3508 18.0664 19.3366 18.0452 19.3187 18.0273ZM11.3688 11.3688C10.375 12.3602 9.05781 12.9062 7.65625 12.9062C6.25469 12.9062 4.9375 12.3602 3.94375 11.3688C2.95234 10.375 2.40625 9.05781 2.40625 7.65625C2.40625 6.25469 2.95234 4.93516 3.94375 3.94375C4.9375 2.95234 6.25469 2.40625 7.65625 2.40625C9.05781 2.40625 10.3773 2.95 11.3688 3.94375C12.3602 4.9375 12.9062 6.25469 12.9062 7.65625C12.9062 9.05781 12.3602 10.3773 11.3688 11.3688Z"
                      fill="#2B2F55"
                    />
                  </svg>
                </div>
              </div>
              {{/*  <button class="search-wrapper" onclick="openModal();">
                <div class="btn-input">Search tutorials</div>
                <div class="search-icon">
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 20 20"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M19.3187 18.0273L13.232 11.9406C14.1766 10.7195 14.6875 9.22656 14.6875 7.65625C14.6875 5.77656 13.9539 4.01406 12.6273 2.68516C11.3008 1.35625 9.53359 0.625 7.65625 0.625C5.77891 0.625 4.01172 1.35859 2.68516 2.68516C1.35625 4.01172 0.625 5.77656 0.625 7.65625C0.625 9.53359 1.35859 11.3008 2.68516 12.6273C4.01172 13.9562 5.77656 14.6875 7.65625 14.6875C9.22656 14.6875 10.7172 14.1766 11.9383 13.2344L18.025 19.3187C18.0428 19.3366 18.064 19.3508 18.0874 19.3604C18.1107 19.3701 18.1357 19.3751 18.1609 19.3751C18.1862 19.3751 18.2112 19.3701 18.2345 19.3604C18.2578 19.3508 18.279 19.3366 18.2969 19.3187L19.3187 18.2992C19.3366 18.2814 19.3508 18.2602 19.3604 18.2369C19.3701 18.2135 19.3751 18.1885 19.3751 18.1633C19.3751 18.138 19.3701 18.113 19.3604 18.0897C19.3508 18.0664 19.3366 18.0452 19.3187 18.0273ZM11.3688 11.3688C10.375 12.3602 9.05781 12.9062 7.65625 12.9062C6.25469 12.9062 4.9375 12.3602 3.94375 11.3688C2.95234 10.375 2.40625 9.05781 2.40625 7.65625C2.40625 6.25469 2.95234 4.93516 3.94375 3.94375C4.9375 2.95234 6.25469 2.40625 7.65625 2.40625C9.05781 2.40625 10.3773 2.95 11.3688 3.94375C12.3602 4.9375 12.9062 6.25469 12.9062 7.65625C12.9062 9.05781 12.3602 10.3773 11.3688 11.3688Z"
                      fill="#2B2F55"
                    />
                  </svg>
                </div>
              </button>  */}}

              {{/* Levels filter */}}
              <div class="select-wrapper">
                <select id="level-select" onchange="filterAndSort();">
                  <option value="all">All levels</option>
                  <option value="beginner">Beginner</option>
                  <option value="intermediate">Intermediate</option>
                  <option value="advanced">Advanced</option>
                </select>
              </div>

              {{/* Reset filters btn */}}
              <button class="reset-filters-btn reset-filters-desktop" onclick="resetFilters();">
                Reset filters
              </button>
            </div>

            <div>
              {{/* Sorting */}}
                <div class="select-wrapper">
                  <label for="sort">Sort By:</label>
                  <select name="sort" id="sort-select" class="fixed" onchange="filterAndSort();">
                    <option value="level">Level</option>
                    <option value="updated">Last Updated</option>
                    <option value="created">Newest</option>
                  </select>
                </div>
            </div>

            <button class="reset-filters-btn reset-filters-mobile" onclick="resetFilters();">
              Reset filters
            </button>
          </div>

          {{/* Tutorials grid */}}
          <div class="grid-page-grid">
            {{ $featured := where $tutorials "Params.featured" true }}
            {{ $notFeatured := where $tutorials "Params.featured" "!=" true }}

            {{/*  Featured tutorials  */}}
            {{ range $featured }}
              {{ partial "tutorial-card" . }}
            {{ end }}

            {{/*  Other tutorials  */}}
            {{ range $notFeatured }}
              {{ partial "tutorial-card" . }}
            {{ end }}
          </div>

          {{/* Footer */}}
          <div class="grid-page-footer">
            <div class="text-section">
              <h2>{{ .Params.contribute.title }}</h2>
              <p>
                {{ .Params.contribute.text }}
              </p>
            </div>

            {{/* Contribute btn */}}
            <div class="button-section">
              {{ partial "contribute-button" . }}
            </div>
          </div>
        </div>
      </div>
    </div>
    {{ partial "tutorial-search-modal" . }}
  </div>

  <script>
    {{/*  Get the tutorials  */}}
    const tutorialCards = Array.from(
      document.querySelectorAll(".grid-page-card")
    );

    const banner = document.querySelector(".tutorials-banner")
    const heroTitle = document.querySelector(".page-hero h1")

    {{/*  Filter and sort  */}}
    const filterAndSort = () => {
      let tutorials = [...tutorialCards]
      {{/*  Get selected filter, sort, and task options   */}}
      const selectedLevel = document.querySelector("#level-select").value;
      const selectedSort = document.querySelector("#sort-select").value;
      const selectedVersion = document.querySelector("#version-select").value;
      const searchTerm = document.querySelector("#search").value;

      {{/*  Filter by level  */}}
      if (selectedLevel !== "all") {
        tutorials = tutorials.filter(t => t.dataset.level === selectedLevel)
      }

      {{/*  Filter by version  */}}
      if (selectedVersion === "2.0") {
        tutorials = tutorials.filter(t => t.dataset.haystack_2)
      } else {
        tutorials = tutorials.filter(t => !t.dataset.haystack_2)
      }

      {{/*  Filter by search  */}}
      if (searchTerm) {
        const searchTermsArray = searchTerm.toLowerCase().split(" ").filter(term => term);

        tutorials = tutorials.filter(i => {
          let text = i.innerText.toLowerCase();
          return searchTermsArray.every(term => text.includes(term));
        });
      }

      {{/*  Sorting  */}}
      if (selectedSort === "created" || selectedSort === "updated") {
        tutorials = tutorials.sort((a, b) => {
          const aFeatured = a.dataset.featured ? 1 : -1;
          const bFeatured = b.dataset.featured ? 1 : -1;
          if (aFeatured !== bFeatured) {
            return bFeatured - aFeatured;
          }

          const aDate = new Date(a.dataset[selectedSort]);
          const bDate = new Date(b.dataset[selectedSort]);
          return bDate - aDate;
        });
      }


      {{/*  Update section title  */}}
      document.querySelector(".section-title").innerHTML = `${tutorials.length} tutorials for <span>${selectedLevel}</span> level${selectedLevel==="all" ? "s":""}`

      {{/*  Update the banner and hero title tag  */}}
      if (selectedVersion === "1.0") {
        banner.classList.remove("v2")
        banner.children[0].innerHTML= `Looking for 2.0 tutorials? Check out <span>here</span>`
        heroTitle.innerHTML = `Tutorials`
      } else {
        banner.classList.add("v2")
        banner.children[0].innerHTML= `Looking for tutorials working with 1.x? Check out <span>here</span>`
        heroTitle.innerHTML = `Tutorials <span class="tag">2.0</span>`
      }

      document.querySelector(".grid-page-grid").innerHTML = ""
      tutorials.forEach((e) =>
        document.querySelector(".grid-page-grid").appendChild(e)
      );

      updateURL(selectedVersion);
    }

    const updateURL = (version) => {
      const params = new URLSearchParams();
      if (version && version !== "2.0") params.set('v', version);
    
      if (params.toString() === '') {
        history.replaceState(null, '', window.location.pathname);
        return;
      }
      history.replaceState(null, '', '?' + params.toString());
    }

    const setFiltersFromParams = () => {
      const params = new URLSearchParams(window.location.search);
      
      const version = params.get('v') || '2.0';
      document.querySelector("#version-select").value = version;
    
      filterAndSort();
    }

    const resetFilters = () => {
      document.querySelector("#level-select").value = "all";
      document.querySelector("#sort-select").value = "level";
      document.querySelector("#version-select").value = "2.0";
      document.querySelector("#search").value = "";
      filterAndSort();
    }

    {{/*  Version toggle for banner  */}}
    const toggleVersion = () => {
      const versionSelect = document.querySelector("#version-select");
      versionSelect.value = versionSelect.value === "2.0" ? "1.0" : "2.0";

      filterAndSort();
    }

    document.querySelector(".tutorials-banner").onclick = toggleVersion;

    {{/*  Modal  */}}
    {{/*  const searchModalContainer = document.querySelector(".search-modal-container");
    const searchModal = document.querySelector(".search-modal");
    const searchModalInput = document.querySelector("#modal-search");
    const searchModalCards = document.querySelector(".search-modal-cards");  */}}
    
    {{/*  Open modal  */}}
    {{/*  const openModal = () => {
      searchModalContainer.classList.add("is-active");

      const body = document.querySelector("body");
      const scrollbarWidth = window.innerWidth - body.clientWidth;
      body.style.overflow = "hidden";

      if (window.innerWidth > 576){
        body.style.paddingRight = scrollbarWidth + "px";
        searchModalContainer.style.paddingRight = scrollbarWidth + "px";
      }

      searchModalInput.focus();
    };  */}}

    {{/*  Close modal  */}}
    {{/*  const closeModal = () => {
      searchModalContainer.classList.remove("is-active");
      
      const body = document.querySelector("body");
      body.style.overflow = "auto";
      body.style.paddingRight = 0;
      searchModalContainer.style.paddingRight = 0;

      setTimeout(() => {
        searchModalInput.value = ""
        searchModal.classList.remove("not-found", "loading")
        searchModal.classList.add("default")
        searchModalCards.innerHTML = ""
      }, 200)

    };  */}}

    {{/*  Close modal on esc  */}}
    {{/*  document.addEventListener("keydown", (e) => {
      if (e.keyCode === 27) {
        closeModal();
      }
    });  */}}

    {{/*  Close modal on outside click  */}}
    {{/*  searchModalContainer.addEventListener("click", (e) => {
      if (e.target === searchModalContainer) {
        closeModal();
      }
    });  */}}

    {{/*  Search  */}}
    {{/*  const searchTutorials = async () => {
      const query = searchModalInput.value
      
      if (!query) return
      searchModal.classList.remove("default", "not-found", "error")
      searchModalCards.innerHTML = ""
      searchModal.classList.add("loading")

      try {
        const response = await fetch(`/api/tutorial-search?query=${query}`);

        if (response.status === 200) {
          const result = await response.json();
          const documents = result.results[0].documents.filter(doc => doc.score > 0.01); // filter out low scored results

          if (documents.length > 0) {
            documents.forEach((doc) => {
              const card = document.createElement("a");
              card.classList.add("search-modal-card");
              const headline = doc.meta.headlines[0]?.headline;
              card.href = `/tutorials/${doc.meta.file_name.toLowerCase().replace(".txt", "")}${headline ? `#${headline.toLowerCase().trim().replace(/ /g, "-").replace(/[.,'\/!$%\^&\*;:{}=()]/g, "")}` : "" }`;
              card.innerHTML = `
              <svg
              width="32"
              height="32"
              viewBox="0 0 32 32"
              fill="none"
                >
                  <g clip-path="url(#clip0_827_12412)">
                    <rect width="32" height="32" fill="#A0A0C0" />
                    <path
                      d="M23.3125 9.83008H19.2906C18.4275 9.83008 17.5838 10.0779 16.8578 10.5455L16 11.0957L15.1422 10.5455C14.4169 10.078 13.5722 9.82962 12.7094 9.83008H8.6875C8.37637 9.83008 8.125 10.0814 8.125 10.3926V20.377C8.125 20.6881 8.37637 20.9395 8.6875 20.9395H12.7094C13.5725 20.9395 14.4162 21.1873 15.1422 21.6549L15.9227 22.1576C15.9455 22.1717 15.9719 22.1805 15.9982 22.1805C16.0246 22.1805 16.051 22.1734 16.0738 22.1576L16.8543 21.6549C17.582 21.1873 18.4275 20.9395 19.2906 20.9395H23.3125C23.6236 20.9395 23.875 20.6881 23.875 20.377V10.3926C23.875 10.0814 23.6236 9.83008 23.3125 9.83008ZM12.7094 19.6738H9.39062V11.0957H12.7094C13.3316 11.0957 13.9363 11.2732 14.4584 11.609L15.3162 12.1592L15.4375 12.2383V20.3594C14.6008 19.9094 13.6656 19.6738 12.7094 19.6738ZM22.6094 19.6738H19.2906C18.3344 19.6738 17.3992 19.9094 16.5625 20.3594V12.2383L16.6838 12.1592L17.5416 11.609C18.0637 11.2732 18.6684 11.0957 19.2906 11.0957H22.6094V19.6738ZM13.9768 13.3457H10.7107C10.6422 13.3457 10.5859 13.4055 10.5859 13.4775V14.2686C10.5859 14.3406 10.6422 14.4004 10.7107 14.4004H13.975C14.0436 14.4004 14.0998 14.3406 14.0998 14.2686V13.4775C14.1016 13.4055 14.0453 13.3457 13.9768 13.3457ZM17.8984 13.4775V14.2686C17.8984 14.3406 17.9547 14.4004 18.0232 14.4004H21.2875C21.3561 14.4004 21.4123 14.3406 21.4123 14.2686V13.4775C21.4123 13.4055 21.3561 13.3457 21.2875 13.3457H18.0232C17.9547 13.3457 17.8984 13.4055 17.8984 13.4775ZM13.9768 15.8066H10.7107C10.6422 15.8066 10.5859 15.8664 10.5859 15.9385V16.7295C10.5859 16.8016 10.6422 16.8613 10.7107 16.8613H13.975C14.0436 16.8613 14.0998 16.8016 14.0998 16.7295V15.9385C14.1016 15.8664 14.0453 15.8066 13.9768 15.8066ZM21.2893 15.8066H18.0232C17.9547 15.8066 17.8984 15.8664 17.8984 15.9385V16.7295C17.8984 16.8016 17.9547 16.8613 18.0232 16.8613H21.2875C21.3561 16.8613 21.4123 16.8016 21.4123 16.7295V15.9385C21.4141 15.8664 21.3578 15.8066 21.2893 15.8066Z"
                      fill="white"
                    />
                  </g>
                  <defs>
                    <clipPath id="clip0_827_12412">
                      <rect width="32" height="32" rx="16" fill="white" />
                    </clipPath>
                  </defs>
                </svg>
    
                <div>
                  <h3>${doc.meta.title}</h3>
                  <p>${doc.content}</p>
    
                  <div class="card-tags">
                    <div>
                      <span class="icon">
                        <svg
                          width="10"
                          height="11"
                          viewBox="0 0 10 11"
                          fill="none"
                        >
                          <path
                            d="M9.64185 4.13731L6.66646 3.70489L5.33638 1.0084C5.30005 0.934575 5.24029 0.874809 5.16646 0.838481C4.9813 0.747075 4.7563 0.823247 4.66372 1.0084L3.33365 3.70489L0.358256 4.13731C0.276224 4.14903 0.201224 4.1877 0.143802 4.24629C0.0743826 4.31764 0.0361291 4.41364 0.0374475 4.51318C0.038766 4.61272 0.0795484 4.70767 0.150834 4.77715L2.30357 6.87598L1.79497 9.83965C1.78305 9.90859 1.79068 9.9795 1.817 10.0443C1.84332 10.1092 1.88727 10.1653 1.94388 10.2064C2.00049 10.2475 2.06749 10.272 2.13728 10.2769C2.20707 10.2819 2.27685 10.2672 2.33872 10.2346L5.00005 8.83536L7.66138 10.2346C7.73404 10.2732 7.81841 10.2861 7.89927 10.2721C8.10318 10.2369 8.24029 10.0436 8.20513 9.83965L7.69654 6.87598L9.84927 4.77715C9.90787 4.71973 9.94654 4.64473 9.95826 4.5627C9.9899 4.35762 9.84693 4.16778 9.64185 4.13731ZM6.79068 6.58067L7.21373 9.04512L5.00005 7.88262L2.78638 9.04629L3.20943 6.58184L1.4188 4.83575L3.8938 4.47598L5.00005 2.23418L6.1063 4.47598L8.5813 4.83575L6.79068 6.58067Z"
                            fill="#2B2F55"
                          />
                        </svg>
                      </span>
                      <span>${doc.meta.level}</span>
                    </div>
    
                    ${doc.meta.completion_time && `<div>
                      <span class="icon">
                        <svg
                          width="12"
                          height="12"
                          viewBox="0 0 12 12"
                          fill="none"
                        >
                          <path
                            d="M6 0.75C3.10078 0.75 0.75 3.10078 0.75 6C0.75 8.89922 3.10078 11.25 6 11.25C8.89922 11.25 11.25 8.89922 11.25 6C11.25 3.10078 8.89922 0.75 6 0.75ZM6 10.3594C3.59297 10.3594 1.64062 8.40703 1.64062 6C1.64062 3.59297 3.59297 1.64062 6 1.64062C8.40703 1.64062 10.3594 3.59297 10.3594 6C10.3594 8.40703 8.40703 10.3594 6 10.3594Z"
                            fill="#2B2F55"
                          />
                          <path
                            d="M8.04726 7.48358L6.37617 6.27538V3.375C6.37617 3.32344 6.33398 3.28125 6.28242 3.28125H5.71875C5.66719 3.28125 5.625 3.32344 5.625 3.375V6.60233C5.625 6.6328 5.63906 6.66093 5.66367 6.67851L7.60195 8.09178C7.64413 8.12225 7.70273 8.11288 7.7332 8.07186L8.06835 7.61483C8.09882 7.57147 8.08945 7.51288 8.04726 7.48358Z"
                            fill="#2B2F55"
                          />
                        </svg>
                      </span>
    
                      <span>${doc.meta.completion_time}</span>
                    </div>`}
                  </div>
                </div>
              `
    
              searchModalCards.appendChild(card)
            })

            searchModal.classList.remove("loading")
          } else {
            searchModal.classList.remove("loading")
            searchModal.classList.add("not-found")
          }

        } else {
          searchModal.classList.remove("loading")
          searchModal.classList.add("error")
        }
      } catch (error) {
        searchModal.classList.remove("loading")
        searchModal.classList.add("error")
      }

    }  */}}

    {{/*  searchModalInput.onkeydown = (e) => {
      if (e.keyCode == 13) {
        searchTutorials()
      }
    }  */}}

    {{/*  function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }  */}}

    {{/*  Reset filters on pageshow in case of back button  */}}
    {{/*  addEventListener('pageshow', () => {
      resetFilters();
    });  */}}

    addEventListener("DOMContentLoaded", () => {
      setFiltersFromParams();
    });
  </script>
{{ end }}